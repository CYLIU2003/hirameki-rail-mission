/**
 * Catalog: Cards / Conditions / Actions
 * This file is used by both server and client.
 * Keep it simple & deterministic for offline kiosks.
 */
(function(global){
  const meta = {
    title: "救援列車ミッション（発車標ハッキング）",
    version: "1.0.0",
  };

  const conditions = [
    { id: "always",      label: "いつでも" },
    { id: "has_rescue",  label: "救援が必要なとき" },
    { id: "crowd_bad",   label: "混雑がひどいとき" },
    { id: "delay_bad",   label: "遅延が大きいとき" },
    { id: "rescue_bad",  label: "救援が間に合ってないとき" },
    { id: "blackout",    label: "停電が起きているとき" },
    { id: "event",       label: "イベント日" },
    { id: "fault",       label: "車両故障があるとき" },
    { id: "peak",        label: "通勤ピークのとき" },
    { id: "multi_trouble", label: "トラブルが複合のとき" },
  ];

  const actions = [
    {
      id: "none",
      label: "（何もしない）",
      effect: { rescue: 0, crowd: 0, delay: 0 },
      description: "作戦なし",
    },
    {
      id: "prioritize_rescue",
      label: "救援を最優先にする",
      effect: { rescue: +8, crowd: 0, delay: -2 },
      description: "救援は速くなるが、他が少し遅れる",
    },
    {
      id: "add_local",
      label: "各停を増発する",
      effect: { rescue: 0, crowd: +8, delay: -3 },
      description: "混雑は減るが、全体遅延が少し増える",
    },
    {
      id: "cancel_express",
      label: "特急を見合わせる",
      effect: { rescue: -1, crowd: +6, delay: +6 },
      description: "整理は進むが、救援は少しだけ後回しになる",
    },
    {
      id: "shorten_turnback",
      label: "折返しを短縮する",
      effect: { rescue: 0, crowd: -1, delay: +8 },
      description: "遅延が大きく改善する（混雑は少しだけ悪化しがち）",
    },
    {
      id: "platform_change",
      label: "番線を変更する",
      effect: { rescue: +2, crowd: +7, delay: +1 },
      description: "流れが良くなる（じわっと効く）",
    },
    {
      id: "detour",
      label: "迂回運転を入れる",
      effect: { rescue: 0, crowd: -2, delay: +6 },
      description: "遅延が改善するが、人の流れが少し乱れる",
    },
    {
      id: "info_guide",
      label: "案内を強化する",
      effect: { rescue: 0, crowd: +6, delay: +2 },
      description: "混雑も遅延も少し良くなる（万能）",
    },
  ];

  /**
   * Card schema:
   * - id: "01".."30"
   * - difficulty: EASY|NORMAL|HARD
   * - tags: ["blackout","event","fault","peak","rescue",...]
   * - initScores: starting goodness 0..100
   * - baseStep: baseline per step (small)
   * - friction: per step penalty for hard feel
   * - pass: thresholds
   * - weights: scoring weights
   * - constraints / bannedActions for HARD
   */
  const cards = [
    // ===== EASY 01-10 =====
    {
      id:"01", difficulty:"EASY",
      title:"停電！救援を最優先",
      brief:"警報：停電発生。病院へ救援物資を急げ！",
      objective:"救援列車をできるだけ早く出発させよう。",
      tags:["blackout","rescue"],
      hint:"「救援を最優先」が効きやすい。",
      recommended:["prioritize_rescue"],
      initScores:{ rescue:42, crowd:58, delay:55 },
      baseStep:{ rescue:+1, crowd:0, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:0 },
      pass:{ rescueMin:70 },
      weights:{ rescue:0.55, crowd:0.25, delay:0.20 },
    },
    {
      id:"02", difficulty:"EASY",
      title:"混雑ホームを落ち着かせろ",
      brief:"ホームが人でいっぱい！転倒注意！",
      objective:"混雑を下げて安全な流れを作ろう。",
      tags:["crowd"],
      hint:"「各停を増発」「案内を強化」が効く。",
      recommended:["add_local","info_guide"],
      initScores:{ rescue:60, crowd:40, delay:55 },
      baseStep:{ rescue:0, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:0 },
      pass:{ crowdMin:70 },
      weights:{ rescue:0.20, crowd:0.55, delay:0.25 },
    },
    {
      id:"03", difficulty:"EASY",
      title:"遅延20分…折返し短縮",
      brief:"遅延が積み上がって雪だるま状態。",
      objective:"遅延を減らして定刻運転へ戻そう。",
      tags:["delay"],
      hint:"「折返し短縮」「迂回運転」が効く。",
      recommended:["shorten_turnback","detour"],
      initScores:{ rescue:58, crowd:55, delay:38 },
      baseStep:{ rescue:0, crowd:0, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:0 },
      pass:{ delayMin:70 },
      weights:{ rescue:0.20, crowd:0.25, delay:0.55 },
    },
    {
      id:"04", difficulty:"EASY",
      title:"イベント帰りで一気に混雑",
      brief:"イベント終了！波のように人が押し寄せる。",
      objective:"混雑を下げて、スムーズに乗せよう。",
      tags:["event"],
      hint:"「各停増発」→「案内強化」が鉄板。",
      recommended:["add_local"],
      initScores:{ rescue:60, crowd:42, delay:52 },
      baseStep:{ rescue:0, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:0 },
      pass:{ crowdMin:65 },
      weights:{ rescue:0.20, crowd:0.55, delay:0.25 },
    },
    {
      id:"05", difficulty:"EASY",
      title:"救援＋混雑（両方ちょい）",
      brief:"救援も必要、ホームも混み始めた。",
      objective:"救援と混雑、両方を60以上にしよう。",
      tags:["rescue","crowd"],
      hint:"救援優先＋案内強化の組み合わせがやりやすい。",
      recommended:["prioritize_rescue","info_guide"],
      initScores:{ rescue:48, crowd:48, delay:55 },
      baseStep:{ rescue:+1, crowd:+1, delay:0 },
      friction:{ rescue:0, crowd:0, delay:0 },
      pass:{ rescueMin:60, crowdMin:60 },
      weights:{ rescue:0.45, crowd:0.40, delay:0.15 },
    },
    {
      id:"06", difficulty:"EASY",
      title:"車両点検で本数が少ない",
      brief:"車両点検で運用がギリギリ！",
      objective:"遅延を抑えて運行を安定させよう。",
      tags:["fault"],
      hint:"見合わせや折返し短縮で運行を整理。",
      recommended:["cancel_express","shorten_turnback"],
      initScores:{ rescue:60, crowd:54, delay:44 },
      baseStep:{ rescue:0, crowd:0, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:0 },
      pass:{ delayMin:60 },
      weights:{ rescue:0.20, crowd:0.25, delay:0.55 },
    },
    {
      id:"07", difficulty:"EASY",
      title:"案内不足で流れが止まる",
      brief:"表示が分かりにくくて人が固まってる！",
      objective:"案内を強化して混雑を下げよう。",
      tags:["crowd"],
      hint:"案内強化か番線変更が効く。",
      recommended:["info_guide","platform_change"],
      initScores:{ rescue:60, crowd:40, delay:60 },
      baseStep:{ rescue:0, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:0 },
      pass:{ crowdMin:65 },
      weights:{ rescue:0.15, crowd:0.60, delay:0.25 },
    },
    {
      id:"08", difficulty:"EASY",
      title:"雨で速度ダウン",
      brief:"雨で安全運転。遅れが出始めた。",
      objective:"遅延を減らして定刻へ戻そう。",
      tags:["delay"],
      hint:"迂回や折返し短縮が効く。",
      recommended:["detour","shorten_turnback"],
      initScores:{ rescue:62, crowd:55, delay:42 },
      baseStep:{ rescue:0, crowd:0, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:0 },
      pass:{ delayMin:65 },
      weights:{ rescue:0.15, crowd:0.25, delay:0.60 },
    },
    {
      id:"09", difficulty:"EASY",
      title:"救援物資が先に必要",
      brief:"とにかく救援が最優先。一本目を急げ！",
      objective:"救援スコアを75以上にしよう。",
      tags:["rescue"],
      hint:"救援優先が最短。",
      recommended:["prioritize_rescue"],
      initScores:{ rescue:40, crowd:60, delay:58 },
      baseStep:{ rescue:+1, crowd:0, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:0 },
      pass:{ rescueMin:75 },
      weights:{ rescue:0.60, crowd:0.20, delay:0.20 },
    },
    {
      id:"10", difficulty:"EASY",
      title:"初めての指令員ミッション",
      brief:"まずは成功体験！好きな作戦で復旧しよう。",
      objective:"総合スコア60以上でクリア！",
      tags:["training"],
      hint:"万能の「案内強化」が安定。",
      recommended:["info_guide"],
      initScores:{ rescue:52, crowd:52, delay:52 },
      baseStep:{ rescue:+1, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:0 },
      pass:{ totalMin:60 },
      weights:{ rescue:0.34, crowd:0.33, delay:0.33 },
    },

    // ===== NORMAL 11-25 =====
    {
      id:"11", difficulty:"NORMAL",
      title:"混雑を下げると遅延が増える？",
      brief:"混雑を下げたいが、増発すると遅延が…",
      objective:"混雑70以上＆遅延55以上の両立を狙え。",
      tags:["crowd","delay"],
      hint:"増発＋折返し短縮の合わせ技。",
      recommended:["add_local","shorten_turnback"],
      initScores:{ rescue:58, crowd:40, delay:44 },
      baseStep:{ rescue:0, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:1 },
      pass:{ crowdMin:70, delayMin:55 },
      weights:{ rescue:0.15, crowd:0.55, delay:0.30 },
    },
    {
      id:"12", difficulty:"NORMAL",
      title:"救援優先で全体が遅れる",
      brief:"救援は急ぐ。でも全体の遅れも抑えたい。",
      objective:"救援75以上＆遅延50以上にしよう。",
      tags:["rescue","delay"],
      hint:"救援優先＋折返し短縮。",
      recommended:["prioritize_rescue","shorten_turnback"],
      initScores:{ rescue:42, crowd:55, delay:42 },
      baseStep:{ rescue:+1, crowd:0, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:1 },
      pass:{ rescueMin:75, delayMin:50 },
      weights:{ rescue:0.50, crowd:0.15, delay:0.35 },
    },
    {
      id:"13", difficulty:"NORMAL",
      title:"番線変更で流れを作れ",
      brief:"人が固まって動けない！導線を変えよう。",
      objective:"混雑70以上を目指そう。",
      tags:["crowd"],
      hint:"番線変更＋案内強化が安定。",
      recommended:["platform_change","info_guide"],
      initScores:{ rescue:60, crowd:38, delay:58 },
      baseStep:{ rescue:0, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:1, delay:0 },
      pass:{ crowdMin:70 },
      weights:{ rescue:0.15, crowd:0.65, delay:0.20 },
    },
    {
      id:"14", difficulty:"NORMAL",
      title:"特急に人が集中",
      brief:"みんな特急に並んでカオス！",
      objective:"混雑70以上を目指そう。",
      tags:["crowd","event"],
      hint:"特急見合わせで分散させよう。",
      recommended:["cancel_express","info_guide"],
      initScores:{ rescue:60, crowd:36, delay:52 },
      baseStep:{ rescue:0, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:1, delay:0 },
      pass:{ crowdMin:70 },
      weights:{ rescue:0.15, crowd:0.65, delay:0.20 },
    },
    {
      id:"15", difficulty:"NORMAL",
      title:"通勤ピーク突入",
      brief:"ピーク！人が増え続ける。",
      objective:"混雑75以上を狙え。",
      tags:["peak","crowd"],
      hint:"増発 or 案内強化。",
      recommended:["add_local","info_guide"],
      initScores:{ rescue:60, crowd:34, delay:50 },
      baseStep:{ rescue:0, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:2, delay:0 },
      pass:{ crowdMin:75 },
      weights:{ rescue:0.10, crowd:0.70, delay:0.20 },
    },
    {
      id:"16", difficulty:"NORMAL",
      title:"車両故障＋救援（忙しい）",
      brief:"故障対応しつつ救援も急げ！",
      objective:"救援65以上＆遅延60以上。",
      tags:["fault","rescue","delay"],
      hint:"折返し短縮か迂回を混ぜる。",
      recommended:["prioritize_rescue","shorten_turnback"],
      initScores:{ rescue:44, crowd:55, delay:40 },
      baseStep:{ rescue:+1, crowd:0, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:2 },
      pass:{ rescueMin:65, delayMin:60 },
      weights:{ rescue:0.45, crowd:0.15, delay:0.40 },
    },
    {
      id:"17", difficulty:"NORMAL",
      title:"案内が悪くて逆走発生",
      brief:"人が右往左往！混雑が悪化。",
      objective:"混雑75以上。",
      tags:["crowd"],
      hint:"案内強化が一番効く。",
      recommended:["info_guide"],
      initScores:{ rescue:60, crowd:32, delay:60 },
      baseStep:{ rescue:0, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:2, delay:0 },
      pass:{ crowdMin:75 },
      weights:{ rescue:0.10, crowd:0.75, delay:0.15 },
    },
    {
      id:"18", difficulty:"NORMAL",
      title:"折返しが詰まって雪だるま遅延",
      brief:"折返しが回らず遅れが増える！",
      objective:"遅延75以上。",
      tags:["delay"],
      hint:"折返し短縮が刺さる。",
      recommended:["shorten_turnback"],
      initScores:{ rescue:58, crowd:52, delay:30 },
      baseStep:{ rescue:0, crowd:0, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:2 },
      pass:{ delayMin:75 },
      weights:{ rescue:0.10, crowd:0.15, delay:0.75 },
    },
    {
      id:"19", difficulty:"NORMAL",
      title:"停電復旧中：使える番線が少ない",
      brief:"番線が限られて人が詰まる！",
      objective:"救援60以上＆混雑60以上。",
      tags:["blackout","rescue","crowd"],
      hint:"番線変更 or 救援優先。",
      recommended:["platform_change","prioritize_rescue"],
      initScores:{ rescue:46, crowd:40, delay:52 },
      baseStep:{ rescue:+1, crowd:+1, delay:0 },
      friction:{ rescue:0, crowd:1, delay:1 },
      pass:{ rescueMin:60, crowdMin:60 },
      weights:{ rescue:0.45, crowd:0.40, delay:0.15 },
    },
    {
      id:"20", difficulty:"NORMAL",
      title:"イベント終了（波が来る）",
      brief:"人の波が止まらない！",
      objective:"混雑75以上。",
      tags:["event","crowd"],
      hint:"増発で押し流そう。",
      recommended:["add_local"],
      initScores:{ rescue:60, crowd:30, delay:52 },
      baseStep:{ rescue:0, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:2, delay:0 },
      pass:{ crowdMin:75 },
      weights:{ rescue:0.10, crowd:0.75, delay:0.15 },
    },
    {
      id:"21", difficulty:"NORMAL",
      title:"迂回運転で一部混雑増",
      brief:"遅延は改善できるが導線が乱れる。",
      objective:"遅延70以上＆混雑55以上。",
      tags:["delay","crowd"],
      hint:"迂回＋案内強化。",
      recommended:["detour","info_guide"],
      initScores:{ rescue:58, crowd:44, delay:38 },
      baseStep:{ rescue:0, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:1, delay:1 },
      pass:{ delayMin:70, crowdMin:55 },
      weights:{ rescue:0.10, crowd:0.35, delay:0.55 },
    },
    {
      id:"22", difficulty:"NORMAL",
      title:"救援は急ぐが、特急も止められない",
      brief:"救援優先＋遅延も抑える。",
      objective:"救援70以上＆遅延55以上。",
      tags:["rescue","delay"],
      hint:"救援優先＋折返し短縮でバランス。",
      recommended:["prioritize_rescue","shorten_turnback"],
      initScores:{ rescue:44, crowd:55, delay:40 },
      baseStep:{ rescue:+1, crowd:0, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:2 },
      pass:{ rescueMin:70, delayMin:55 },
      weights:{ rescue:0.50, crowd:0.15, delay:0.35 },
    },
    {
      id:"23", difficulty:"NORMAL",
      title:"乗換駅が混雑、分散が必要",
      brief:"乗換動線が詰まって危険！",
      objective:"混雑75以上。",
      tags:["crowd"],
      hint:"番線変更と案内強化。",
      recommended:["platform_change","info_guide"],
      initScores:{ rescue:60, crowd:28, delay:58 },
      baseStep:{ rescue:0, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:2, delay:0 },
      pass:{ crowdMin:75 },
      weights:{ rescue:0.10, crowd:0.75, delay:0.15 },
    },
    {
      id:"24", difficulty:"NORMAL",
      title:"ホーム点検で速度制限",
      brief:"安全のため速度を落として運行。",
      objective:"遅延70以上。",
      tags:["delay"],
      hint:"迂回 or 折返し短縮。",
      recommended:["detour","shorten_turnback"],
      initScores:{ rescue:58, crowd:55, delay:34 },
      baseStep:{ rescue:0, crowd:0, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:2 },
      pass:{ delayMin:70 },
      weights:{ rescue:0.10, crowd:0.15, delay:0.75 },
    },
    {
      id:"25", difficulty:"NORMAL",
      title:"全部そこそこミッション",
      brief:"救援・混雑・遅延、全部60以上にしよう。",
      objective:"三つのスコアを全部60以上。",
      tags:["rescue","crowd","delay"],
      hint:"万能の案内強化＋どれか1つ。",
      recommended:["info_guide","platform_change"],
      initScores:{ rescue:45, crowd:45, delay:45 },
      baseStep:{ rescue:+1, crowd:+1, delay:+1 },
      friction:{ rescue:1, crowd:1, delay:1 },
      pass:{ rescueMin:60, crowdMin:60, delayMin:60 },
      weights:{ rescue:0.34, crowd:0.33, delay:0.33 },
    },

    // ===== HARD 26-30 =====
    {
      id:"26", difficulty:"HARD",
      title:"縛り：特急見合わせ禁止",
      brief:"特急は止められない！別の手で混雑を下げろ。",
      objective:"混雑70以上＆遅延60以上。",
      tags:["crowd","peak"],
      constraints:["特急見合わせ（使えない）"],
      bannedActions:["cancel_express"],
      hint:"増発＋案内 or 折返し短縮。",
      recommended:["add_local","info_guide"],
      initScores:{ rescue:58, crowd:30, delay:40 },
      baseStep:{ rescue:0, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:3, delay:2 },
      pass:{ crowdMin:70, delayMin:60 },
      weights:{ rescue:0.10, crowd:0.60, delay:0.30 },
    },
    {
      id:"27", difficulty:"HARD",
      title:"縛り：増発できない（車両不足）",
      brief:"車両が足りない！増発なしで流れを作れ。",
      objective:"混雑65以上＆遅延70以上。",
      tags:["crowd","fault","delay"],
      constraints:["各停増発（使えない）"],
      bannedActions:["add_local"],
      hint:"番線変更＋折返し短縮が王道。",
      recommended:["platform_change","shorten_turnback"],
      initScores:{ rescue:58, crowd:34, delay:32 },
      baseStep:{ rescue:0, crowd:+1, delay:+1 },
      friction:{ rescue:0, crowd:2, delay:3 },
      pass:{ crowdMin:65, delayMin:70 },
      weights:{ rescue:0.10, crowd:0.40, delay:0.50 },
    },
    {
      id:"28", difficulty:"HARD",
      title:"縛り：救援優先すると遅延が跳ねる",
      brief:"救援は必要。でも全体遅延も守れ！",
      objective:"救援75以上＆遅延55以上。",
      tags:["rescue","delay","blackout"],
      constraints:["救援優先は“諸刃”になりやすい"],
      hint:"救援＋迂回/折返しで帳尻を合わせる。",
      recommended:["prioritize_rescue","detour"],
      initScores:{ rescue:38, crowd:55, delay:34 },
      baseStep:{ rescue:+1, crowd:0, delay:+1 },
      friction:{ rescue:0, crowd:0, delay:3 },
      pass:{ rescueMin:75, delayMin:55 },
      weights:{ rescue:0.55, crowd:0.10, delay:0.35 },
    },
    {
      id:"29", difficulty:"HARD",
      title:"複合：故障＋ピーク＋救援",
      brief:"全部来た！指令員の腕の見せ所。",
      objective:"総合75以上でクリア！",
      tags:["fault","peak","rescue","delay","crowd"],
      hint:"折返し短縮＋番線変更で土台を作り、救援は案内で補う。",
      recommended:["shorten_turnback","platform_change"],
      initScores:{ rescue:35, crowd:30, delay:28 },
      baseStep:{ rescue:+1, crowd:+1, delay:+1 },
      friction:{ rescue:3, crowd:3, delay:3 },
      pass:{ totalMin:75 },
      weights:{ rescue:0.40, crowd:0.30, delay:0.30 },
    },
    {
      id:"30", difficulty:"HARD",
      title:"最終試験：ルール1個だけ！",
      brief:"縛り：作戦は1つだけ。最善手を選べ。",
      objective:"救援70以上＆混雑70以上。",
      tags:["rescue","crowd","event"],
      constraints:["作戦は1個だけ（2個目は無効）"],
      hint:"救援優先か案内強化のどちらかで勝負。",
      recommended:["prioritize_rescue","info_guide"],
      initScores:{ rescue:40, crowd:32, delay:55 },
      baseStep:{ rescue:+1, crowd:+1, delay:0 },
      friction:{ rescue:2, crowd:2, delay:1 },
      pass:{ rescueMin:70, crowdMin:70 },
      weights:{ rescue:0.50, crowd:0.40, delay:0.10 },
      // We'll enforce "only 1 rule" in client; server still accepts 2 but client hides 2nd.
    },
  ];

  // If you want exactly 30 with NORMAL 11-25, we already have 15 NORMAL; good.

  const CATALOG = { meta, conditions, actions, cards };

  // Node.js require support
  if (typeof module !== "undefined" && module.exports) {
    module.exports = CATALOG;
  } else {
    global.CATALOG = CATALOG;
  }
})(typeof window !== "undefined" ? window : globalThis);
